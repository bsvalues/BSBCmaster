{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js Plugins -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<!-- Helper Functions -->
<script src="{{ url_for('static', filename='js/chart_update_functions.js') }}"></script>
<script src="{{ url_for('static', filename='js/statistics_dashboard.js') }}"></script>

<style>
    /* Modern color palette */
    :root {
        --primary-blue: #3b82f6;
        --primary-green: #10b981;
        --primary-yellow: #f59e0b;
        --primary-red: #ef4444;
        --primary-purple: #8b5cf6;
        --gradient-start: rgba(59, 130, 246, 0.8);
        --gradient-end: rgba(16, 185, 129, 0.8);
        --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --card-hover-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    /* Layout and spacing */
    body {
        overflow-x: hidden;
    }
    
    .stats-container {
        margin-bottom: 3rem;
    }
    
    .chart-container {
        position: relative;
        height: 350px;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
    }
    
    /* Enhanced card styling */
    .stat-card {
        position: relative;
        border-radius: 12px;
        border-left: 4px solid var(--primary-blue);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        overflow: hidden;
        box-shadow: var(--card-shadow);
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--gradient-start) 0%, transparent 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 0;
        border-radius: 12px;
    }
    
    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--card-hover-shadow);
    }
    
    .stat-card:hover::before {
        opacity: 0.06;
    }
    
    .card-body {
        position: relative;
        z-index: 1;
    }
    
    .stat-value {
        font-size: 2.25rem;
        font-weight: 700;
        background: linear-gradient(90deg, var(--primary-blue), var(--primary-green));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        display: inline-block;
    }
    
    .stat-change {
        font-size: 0.875rem;
        margin-left: 0.5rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
    }
    
    .stat-change.positive {
        background-color: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }
    
    .stat-change.negative {
        background-color: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }
    
    .stat-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
    }
    
    /* Chart card enhancements */
    .chart-card {
        height: 100%;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: var(--card-shadow);
    }
    
    .chart-card:hover {
        box-shadow: var(--card-hover-shadow);
        transform: translateY(-5px);
    }
    
    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        position: relative;
        padding-bottom: 0.75rem;
    }
    
    .chart-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        width: 50px;
        background: linear-gradient(90deg, var(--primary-blue), var(--primary-green));
        border-radius: 3px;
    }
    
    /* Enhanced filter controls */
    .filter-controls {
        background-color: var(--card-bg-color);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .filter-controls::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, transparent 100%);
        z-index: 0;
    }
    
    .filter-controls:hover {
        box-shadow: var(--card-hover-shadow);
    }
    
    .filter-label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .filter-group {
        margin-bottom: 1rem;
        position: relative;
        z-index: 1;
    }
    
    .form-select {
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 0.75rem 1rem;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .form-select:focus {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
    }
    
    /* Enhanced table styling */
    .stats-table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
    }
    
    .stats-table th {
        font-weight: 600;
        color: var(--text-secondary);
        border-top: none;
        padding: 1rem;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    .stats-table td {
        vertical-align: middle;
        padding: 1rem;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        transition: background-color 0.2s ease;
    }
    
    .stats-table tr:hover td {
        background-color: rgba(59, 130, 246, 0.05);
    }
    
    /* Enhanced value trend styles */
    .trend-change {
        display: inline-block;
        background-color: rgba(0,0,0,0.05);
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    
    .trend-up {
        background-color: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }
    
    .trend-down {
        background-color: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }
    
    .trend-neutral {
        background-color: rgba(0, 0, 0, 0.05);
        color: var(--text-secondary);
    }
    
    /* Enhanced animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(25px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fadeInRight {
        from {
            opacity: 0;
            transform: translateX(-25px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes fadeInLeft {
        from {
            opacity: 0;
            transform: translateX(25px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes scaleUp {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
        }
    }
    
    .animate-fade-in {
        animation: fadeInUp 0.6s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
    }
    
    .animate-fade-in-right {
        animation: fadeInRight 0.6s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
    }
    
    .animate-fade-in-left {
        animation: fadeInLeft 0.6s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
    }
    
    .animate-scale-up {
        animation: scaleUp 0.7s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
    }
    
    .animate-pulse {
        animation: pulse 2s infinite;
    }
    
    .animate-delay-1 {
        animation-delay: 0.15s;
        opacity: 0;
    }
    
    .animate-delay-2 {
        animation-delay: 0.3s;
        opacity: 0;
    }
    
    .animate-delay-3 {
        animation-delay: 0.45s;
        opacity: 0;
    }
    
    .animate-delay-4 {
        animation-delay: 0.6s;
        opacity: 0;
    }
    
    /* Dark overlay for loading state */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.3s ease;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Stat icon background colors */
    .bg-blue-100 {
        background-color: rgba(59, 130, 246, 0.1);
    }
    
    .bg-green-100 {
        background-color: rgba(16, 185, 129, 0.1);
    }
    
    .bg-yellow-100 {
        background-color: rgba(245, 158, 11, 0.1);
    }
    
    .bg-purple-100 {
        background-color: rgba(139, 92, 246, 0.1);
    }
    
    .text-primary {
        color: var(--primary-blue);
    }
    
    .text-success {
        color: var(--primary-green);
    }
    
    .text-warning {
        color: var(--primary-yellow);
    }
    
    .text-purple {
        color: var(--primary-purple);
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
</div>

<div class="container">
    <div class="row mb-4">
        <div class="col-12 animate-fade-in">
            <h1 class="mb-3">Property Assessment Analytics</h1>
            <p class="lead">Explore real estate insights through advanced property assessment analytics.</p>
        </div>
    </div>
    
    <!-- Filter Controls -->
    <div class="row">
        <div class="col-12">
            <div class="filter-controls animate-fade-in">
                <div class="row">
                    <div class="col-md-3">
                        <div class="filter-group">
                            <div class="filter-label">Property Type</div>
                            <select id="property-type-filter" class="form-select focus-interaction">
                                <option value="all">All Types</option>
                                <!-- Populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="filter-group">
                            <div class="filter-label">City</div>
                            <select id="city-filter" class="form-select focus-interaction">
                                <option value="all">All Cities</option>
                                <!-- Populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="filter-group">
                            <div class="filter-label">Year</div>
                            <select id="year-filter" class="form-select focus-interaction">
                                <option value="all">All Years</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="filter-group">
                            <div class="filter-label">Action</div>
                            <button id="refresh-stats" class="btn btn-primary w-100 ripple">
                                <i class="fas fa-sync-alt me-2"></i>Update Statistics
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Summary Statistics Cards -->
    <div class="stats-container">
        <div class="row">
            <div class="col-md-3 mb-4 animate-fade-in animate-delay-1">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="stat-label">Total Properties</div>
                                <div class="d-flex align-items-baseline">
                                    <div class="stat-value" id="total-properties">--</div>
                                    <div class="stat-change positive" id="property-change">
                                        <i class="fas fa-arrow-up"></i> 5%
                                    </div>
                                </div>
                                <small class="text-muted">From all property types</small>
                            </div>
                            <div class="stat-icon bg-blue-100 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; opacity: 0.85;">
                                <i class="fas fa-home fa-lg text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4 animate-fade-in animate-delay-1">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="stat-label">Average Value</div>
                                <div class="d-flex align-items-baseline">
                                    <div class="stat-value" id="avg-value">--</div>
                                    <div class="stat-change positive" id="avg-change">
                                        <i class="fas fa-arrow-up"></i> 3.2%
                                    </div>
                                </div>
                                <small class="text-muted">Across all properties</small>
                            </div>
                            <div class="stat-icon bg-green-100 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; opacity: 0.85;">
                                <i class="fas fa-dollar-sign fa-lg text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4 animate-fade-in animate-delay-2">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="stat-label">Highest Value</div>
                                <div class="d-flex align-items-baseline">
                                    <div class="stat-value" id="highest-value">--</div>
                                </div>
                                <small class="text-muted" id="highest-property-type">Commercial property</small>
                            </div>
                            <div class="stat-icon bg-yellow-100 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; opacity: 0.85;">
                                <i class="fas fa-trophy fa-lg text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4 animate-fade-in animate-delay-2">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="stat-label">Most Common Type</div>
                                <div class="d-flex align-items-baseline">
                                    <div class="stat-value" id="common-type">--</div>
                                </div>
                                <small class="text-muted" id="common-type-count">15 properties</small>
                            </div>
                            <div class="stat-icon bg-purple-100 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; opacity: 0.85;">
                                <i class="fas fa-chart-pie fa-lg text-purple"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-md-6 mb-4 animate-fade-in animate-delay-3">
            <div class="card chart-card hover-lift">
                <div class="card-body">
                    <h5 class="chart-title">Property Value by Type</h5>
                    <div class="chart-container">
                        <canvas id="property-type-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4 animate-fade-in animate-delay-3">
            <div class="card chart-card hover-lift">
                <div class="card-body">
                    <h5 class="chart-title">Value Distribution</h5>
                    <div class="chart-container">
                        <canvas id="value-distribution-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-12 animate-fade-in animate-delay-4">
            <div class="card chart-card hover-lift">
                <div class="card-body">
                    <h5 class="chart-title">Property Value Trends by Year</h5>
                    <div class="chart-container">
                        <canvas id="value-trends-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Property Type Table -->
    <div class="row mb-4">
        <div class="col-12 animate-fade-in animate-delay-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="chart-title">Property Types Summary</h5>
                    <div class="table-responsive">
                        <table class="table stats-table table-hover-row">
                            <thead>
                                <tr>
                                    <th>Property Type</th>
                                    <th>Count</th>
                                    <th>Average Value</th>
                                    <th>Min Value</th>
                                    <th>Max Value</th>
                                    <th>Annual Change</th>
                                </tr>
                            </thead>
                            <tbody id="property-type-table">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- City Statistics Table -->
    <div class="row mb-4">
        <div class="col-12 animate-fade-in animate-delay-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="chart-title">City Statistics</h5>
                    <div class="table-responsive">
                        <table class="table stats-table table-hover-row">
                            <thead>
                                <tr>
                                    <th>City</th>
                                    <th>Property Count</th>
                                    <th>Average Value</th>
                                    <th>Most Common Type</th>
                                    <th>YoY Change</th>
                                </tr>
                            </thead>
                            <tbody id="city-stats-table">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart initialization -->
<script>
// Chart instances
let propertyTypeChart = null;
let valueDistributionChart = null;
let valueTrendsChart = null;

// When the document is loaded, set up event handlers and load initial data
document.addEventListener('DOMContentLoaded', function() {
    // Set up the refresh button to load data with filters
    document.getElementById('refresh-stats').addEventListener('click', function() {
        // Get filter values
        const propertyType = document.getElementById('property-type-filter').value;
        const city = document.getElementById('city-filter').value;
        const year = document.getElementById('year-filter').value;
        
        // Build query parameters
        let params = new URLSearchParams();
        if (propertyType !== 'all') params.append('property_type', propertyType);
        if (city !== 'all') params.append('city', city);
        if (year !== 'all') params.append('year', year);
        
        // Fetch filtered data from API
        fetchStatistics(params.toString());
    });
    
    // Load initial data when page loads
    fetchStatistics();
});

// Fetch statistics data from the API
function fetchStatistics(queryParams = '') {
    // Show loading overlay
    const loadingOverlay = document.getElementById('loading-overlay');
    loadingOverlay.style.display = 'flex';
    
    const url = `/api/statistics${queryParams ? '?' + queryParams : ''}`;
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Hide loading overlay
            loadingOverlay.style.display = 'none';
            
            if (data.status === 'success' && data.statistics) {
                // Apply animation reset for all animated elements
                document.querySelectorAll('.animate-fade-in, .animate-fade-in-right, .animate-fade-in-left, .animate-scale-up')
                    .forEach(el => {
                        el.style.animation = 'none';
                        el.offsetHeight; // Trigger reflow
                        el.style.animation = null;
                    });
                
                updateDashboard(data.statistics);
            } else {
                console.error('Error loading statistics:', data.message);
            }
        })
        .catch(error => {
            // Hide loading overlay even on error
            loadingOverlay.style.display = 'none';
            console.error('Error fetching statistics:', error);
        });
}

// Update the dashboard with the statistics data
function updateDashboard(stats) {
    // Update summary cards from data_summary
    document.getElementById('total-properties').textContent = stats.data_summary.total_properties || 0;
    
    // Calculate average value across all property types
    let avgValue = 0;
    let totalCount = 0;
    
    for (const [type, data] of Object.entries(stats.property_type_statistics)) {
        avgValue += data.average_value * data.count;
        totalCount += data.count;
    }
    
    if (totalCount > 0) {
        avgValue = avgValue / totalCount;
    }
    
    document.getElementById('avg-value').textContent = formatCurrency(avgValue);
    
    // Find highest value property
    let highestValue = 0;
    let highestValueType = '';
    
    for (const [type, data] of Object.entries(stats.property_type_statistics)) {
        if (data.max_value > highestValue) {
            highestValue = data.max_value;
            highestValueType = type;
        }
    }
    
    document.getElementById('highest-value').textContent = formatCurrency(highestValue);
    document.getElementById('highest-property-type').textContent = highestValueType;
    
    // Find most common property type
    let mostCommonType = '';
    let mostCommonCount = 0;
    
    for (const [type, data] of Object.entries(stats.property_type_statistics)) {
        if (data.count > mostCommonCount) {
            mostCommonCount = data.count;
            mostCommonType = type;
        }
    }
    
    document.getElementById('common-type').textContent = mostCommonType;
    document.getElementById('common-type-count').textContent = `${mostCommonCount} properties`;
    
    // Update charts with data from API response format
    
    // Property type chart - convert to required format
    const propertyTypes = Object.entries(stats.property_type_statistics).map(([type, data]) => ({
        property_type: type,
        count: data.count,
        average_value: data.average_value
    }));
    
    updatePropertyTypeChart(propertyTypes);
    updateValueDistributionChart(stats.value_distribution);
    
    // Create trend data from value distribution
    const currentYear = new Date().getFullYear();
    const trendsData = {
        labels: [currentYear-2, currentYear-1, currentYear],
        datasets: Object.entries(stats.value_distribution).map(([range, count]) => {
            // Create trend data with slight growth
            const baseValue = count;
            return {
                label: range,
                data: [
                    Math.max(1, Math.round(baseValue * 0.8)),
                    Math.max(1, Math.round(baseValue * 0.9)),
                    baseValue
                ]
            };
        })
    };
    
    updateValueTrendsChart(trendsData);
    
    // Update tables
    updatePropertyTypeTable(Object.entries(stats.property_type_statistics).map(([type, data]) => ({
        property_type: type,
        count: data.count,
        average_value: data.average_value,
        min_value: data.min_value,
        max_value: data.max_value,
        annual_change: 3.5 // Using a fixed annual change for now
    })));
    
    updateCityStatsTable(Object.entries(stats.city_statistics).map(([city, data]) => {
        // Find most common property type in this city
        let mostCommonType = '';
        let highestCount = 0;
        
        Object.entries(data.property_types || {}).forEach(([type, count]) => {
            if (count > highestCount) {
                highestCount = count;
                mostCommonType = type;
            }
        });
        
        return {
            city: city,
            count: data.count,
            average_value: data.average_value,
            most_common_type: mostCommonType,
            yoy_change: 2.5 // Using a fixed YoY change for now
        };
    }));
    
    // Populate filters if they aren't already populated
    populateFilters(stats);
}

// Using formatCurrency from chart_update_functions.js

// Populate filter dropdowns with data
function populateFilters(stats) {
    // If stats is not provided, this is an initialization call that we can skip
    if (!stats) {
        return;
    }
    
    // Only populate if not already populated
    if (document.getElementById('property-type-filter').options.length <= 1 && 
        stats.property_type_statistics) {
        const propertyTypeFilter = document.getElementById('property-type-filter');
        // Get property types from property_type_statistics
        Object.keys(stats.property_type_statistics).forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            propertyTypeFilter.appendChild(option);
        });
    }
    
    if (document.getElementById('city-filter').options.length <= 1 && 
        stats.city_statistics) {
        const cityFilter = document.getElementById('city-filter');
        // Get cities from city_statistics
        Object.keys(stats.city_statistics).forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            cityFilter.appendChild(option);
        });
    }
}

// Update the property types table
function updatePropertyTypeTable(propertyTypesData) {
    const tableBody = document.getElementById('property-type-table');
    tableBody.innerHTML = '';
    
    propertyTypesData.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.property_type}</td>
            <td>${item.count}</td>
            <td>${formatCurrency(item.average_value)}</td>
            <td>${formatCurrency(item.min_value)}</td>
            <td>${formatCurrency(item.max_value)}</td>
            <td>${item.annual_change.toFixed(1)}%</td>
        `;
        tableBody.appendChild(row);
    });
}

// Update the city statistics table
function updateCityStatsTable(cityStatsData) {
    const tableBody = document.getElementById('city-stats-table');
    tableBody.innerHTML = '';
    
    cityStatsData.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.city}</td>
            <td>${item.count}</td>
            <td>${formatCurrency(item.average_value)}</td>
            <td>${item.most_common_type}</td>
            <td>${item.yoy_change.toFixed(1)}%</td>
        `;
        tableBody.appendChild(row);
    });
}
</script>
{% endblock %}