{% extends "base.html" %}

{% block title %}{{ title }} - MCP Assessor Agent API{% endblock %}

{% block head %}
<!-- Leaflet.js CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
<style>
    #map-container {
        position: relative;
        height: calc(100vh - 180px);
        min-height: 500px;
    }
    #property-map {
        height: 100%;
        width: 100%;
        border-radius: 4px;
    }
    .map-sidebar {
        padding: 15px;
        border-radius: 4px;
    }
    .map-control-section {
        margin-bottom: 20px;
    }
    .property-popup {
        min-width: 250px;
    }
    .loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        padding: 10px 20px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border-radius: 4px;
        display: none;
    }
    .property-legend {
        background-color: white;
        padding: 10px;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    .legend-marker {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .stats-panel {
        background-color: var(--bs-dark);
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 15px;
    }
    .stats-header {
        border-bottom: 1px solid var(--bs-border-color);
        padding-bottom: 8px;
        margin-bottom: 10px;
    }
    .stats-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1>Property Map</h1>
            <p class="lead">Visualize property assessment data geographically to identify patterns and trends.</p>
        </div>
    </div>

    <div class="row">
        <!-- Map Controls Sidebar -->
        <div class="col-md-3">
            <div class="map-sidebar">
                <h4>Map Controls</h4>
                
                <!-- Data Source Selection -->
                <div class="map-control-section">
                    <label for="data-source" class="form-label">Data Source</label>
                    <select class="form-select" id="data-source">
                        <option value="accounts" selected>Property Accounts</option>
                    </select>
                </div>
                
                <!-- Value Filtering -->
                <div class="map-control-section">
                    <label for="value-filter" class="form-label">Value Range</label>
                    <select class="form-select" id="value-filter">
                        <option value="all" selected>All Properties</option>
                        <option value="0-100000">Under $100,000</option>
                        <option value="100000-250000">$100,000 - $250,000</option>
                        <option value="250000-500000">$250,000 - $500,000</option>
                        <option value="500000-1000000">$500,000 - $1,000,000</option>
                        <option value="1000000+">Over $1,000,000</option>
                    </select>
                </div>
                
                <!-- City Filtering -->
                <div class="map-control-section">
                    <label for="city-filter" class="form-label">City</label>
                    <select class="form-select" id="city-filter">
                        <option value="all" selected>All Cities</option>
                        <!-- Cities will be loaded dynamically -->
                    </select>
                </div>
                
                <!-- Property Type Filtering -->
                <div class="map-control-section">
                    <label for="property-type-filter" class="form-label">Property Type</label>
                    <div class="form-check">
                        <input class="form-check-input property-type-checkbox" type="checkbox" value="Residential" id="residential-checkbox" checked>
                        <label class="form-check-label" for="residential-checkbox">
                            Residential
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input property-type-checkbox" type="checkbox" value="Commercial" id="commercial-checkbox" checked>
                        <label class="form-check-label" for="commercial-checkbox">
                            Commercial
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input property-type-checkbox" type="checkbox" value="Agricultural" id="agricultural-checkbox" checked>
                        <label class="form-check-label" for="agricultural-checkbox">
                            Agricultural
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input property-type-checkbox" type="checkbox" value="Industrial" id="industrial-checkbox" checked>
                        <label class="form-check-label" for="industrial-checkbox">
                            Industrial
                        </label>
                    </div>
                </div>
                
                <!-- Apply Filters Button -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="apply-filters">Apply Filters</button>
                </div>

                <!-- Statistics Section -->
                <div class="stats-panel mt-4">
                    <div class="stats-header">
                        <h5 class="mb-0">Property Statistics</h5>
                    </div>
                    <div id="property-stats">
                        <div class="stats-item">
                            <span>Properties:</span>
                            <span id="stat-count">0</span>
                        </div>
                        <div class="stats-item">
                            <span>Average Value:</span>
                            <span id="stat-avg">$0</span>
                        </div>
                        <div class="stats-item">
                            <span>Median Value:</span>
                            <span id="stat-median">$0</span>
                        </div>
                        <div class="stats-item">
                            <span>Value Range:</span>
                            <span id="stat-range">$0 - $0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map Display Area -->
        <div class="col-md-9">
            <div id="map-container">
                <div id="property-map"></div>
                <div class="loading-indicator" id="map-loading">
                    <span><i class="fas fa-spinner fa-spin me-2"></i> Loading map data...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet.js JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the map
        const map = L.map('property-map').setView([46.28, -119.29], 11);
        
        // Add base tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Property markers layer group
        let propertyLayer = L.layerGroup().addTo(map);
        
        // Legend
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'property-legend');
            div.innerHTML = `
                <h6>Property Types</h6>
                <div class="legend-item">
                    <div class="legend-marker" style="background-color: #4CAF50;"></div>
                    <span>Residential</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker" style="background-color: #2196F3;"></div>
                    <span>Commercial</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker" style="background-color: #FFC107;"></div>
                    <span>Agricultural</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker" style="background-color: #F44336;"></div>
                    <span>Industrial</span>
                </div>
            `;
            return div;
        };
        legend.addTo(map);
        
        // Load cities dropdown
        fetch('/api/map/cities')
            .then(response => response.json())
            .then(data => {
                const citySelect = document.getElementById('city-filter');
                data.cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching cities:', error));
        
        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
            }).format(value);
        }
        
        // Get marker color based on property type
        function getMarkerColor(propertyType) {
            switch(propertyType) {
                case 'Commercial': return '#2196F3';
                case 'Agricultural': return '#FFC107';
                case 'Industrial': return '#F44336';
                default: return '#4CAF50'; // Residential
            }
        }
        
        // Create custom marker
        function createPropertyMarker(feature, latlng) {
            const propertyType = feature.properties.property_type || 'Residential';
            const markerColor = getMarkerColor(propertyType);
            
            return L.circleMarker(latlng, {
                radius: 8,
                fillColor: markerColor,
                color: '#fff',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            });
        }
        
        // Create popup content
        function createPopupContent(properties) {
            return `
                <div class="property-popup">
                    <h6>${properties.property_address || 'Property'}</h6>
                    <p><strong>Account ID:</strong> ${properties.account_id || 'N/A'}</p>
                    <p><strong>Owner:</strong> ${properties.owner_name || 'N/A'}</p>
                    <p><strong>City:</strong> ${properties.property_city || 'N/A'}</p>
                    <p><strong>Type:</strong> ${properties.property_type || 'Residential'}</p>
                    <p><strong>Value:</strong> ${formatCurrency(properties.assessed_value || 0)}</p>
                    <button class="btn btn-sm btn-outline-primary view-images-btn" 
                        data-account-id="${properties.account_id}">
                        View Images
                    </button>
                </div>
            `;
        }
        
        // Update property statistics display
        function updateStatistics(stats) {
            document.getElementById('stat-count').textContent = stats.count.toLocaleString();
            document.getElementById('stat-avg').textContent = formatCurrency(stats.average_value);
            document.getElementById('stat-median').textContent = formatCurrency(stats.median_value);
            document.getElementById('stat-range').textContent = 
                `${formatCurrency(stats.min_value)} - ${formatCurrency(stats.max_value)}`;
        }
        
        // Load map data with filters
        function loadMapData() {
            // Show loading indicator
            document.getElementById('map-loading').style.display = 'block';
            
            // Get selected filters
            const dataSource = document.getElementById('data-source').value;
            const valueFilter = document.getElementById('value-filter').value;
            const cityFilter = document.getElementById('city-filter').value;
            
            // Get selected property types
            const selectedPropertyTypes = [];
            document.querySelectorAll('.property-type-checkbox:checked').forEach(checkbox => {
                selectedPropertyTypes.push(checkbox.value);
            });
            
            // Build URL with query parameters
            const url = new URL('/api/map/data', window.location.origin);
            url.searchParams.append('data_source', dataSource);
            url.searchParams.append('value_filter', valueFilter);
            if (cityFilter !== 'all') {
                url.searchParams.append('city', cityFilter);
            }
            
            // Fetch map data
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Clear existing markers
                    propertyLayer.clearLayers();
                    
                    // Filter properties by selected property types
                    const filteredFeatures = data.geojson.features.filter(feature => 
                        selectedPropertyTypes.includes(feature.properties.property_type));
                    
                    // Create new GeoJSON with filtered features
                    const filteredGeoJSON = {
                        type: 'FeatureCollection',
                        features: filteredFeatures
                    };
                    
                    // Add GeoJSON layer with custom marker and popup
                    L.geoJSON(filteredGeoJSON, {
                        pointToLayer: createPropertyMarker,
                        onEachFeature: function(feature, layer) {
                            layer.bindPopup(createPopupContent(feature.properties));
                        }
                    }).addTo(propertyLayer);
                    
                    // Update statistics
                    updateStatistics(data.statistics);
                    
                    // Adjust map bounds
                    if (filteredFeatures.length > 0) {
                        map.fitBounds([
                            [data.bounds.south, data.bounds.west],
                            [data.bounds.north, data.bounds.east]
                        ]);
                    }
                    
                    // Hide loading indicator
                    document.getElementById('map-loading').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error fetching map data:', error);
                    document.getElementById('map-loading').style.display = 'none';
                });
        }
        
        // Handle Apply Filters button click
        document.getElementById('apply-filters').addEventListener('click', loadMapData);
        
        // Handle property image button clicks
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('view-images-btn')) {
                const accountId = e.target.getAttribute('data-account-id');
                
                // Fetch property images
                fetch(`/api/map/property-images/${accountId}`)
                    .then(response => response.json())
                    .then(data => {
                        // Create image gallery HTML
                        let imagesHtml = '<div class="property-images">';
                        
                        if (data.data && data.data.length > 0) {
                            data.data.forEach(image => {
                                imagesHtml += `
                                    <div class="mb-2">
                                        <img src="${image.image_url}" 
                                            alt="${image.image_description || 'Property image'}" 
                                            class="img-fluid img-thumbnail">
                                        <small class="d-block text-muted">
                                            ${image.image_type || 'Property'} - 
                                            ${image.image_date ? new Date(image.image_date).toLocaleDateString() : 'No date'}
                                        </small>
                                    </div>
                                `;
                            });
                        } else {
                            imagesHtml += '<p>No images available for this property.</p>';
                        }
                        
                        imagesHtml += '</div>';
                        
                        // Create and show a popup with the images
                        L.popup()
                            .setLatLng(map.getCenter())
                            .setContent(imagesHtml)
                            .openOn(map);
                    })
                    .catch(error => {
                        console.error('Error fetching property images:', error);
                        L.popup()
                            .setLatLng(map.getCenter())
                            .setContent('<p>Error loading property images.</p>')
                            .openOn(map);
                    });
            }
        });
        
        // Initial data load
        loadMapData();
    });
</script>
{% endblock %}
